import{h as _e,i as ve,j as we}from"./chunk-GEEM2TOX.js";import{a as be,b as Ce,c as Se}from"./chunk-Y2PEHK34.js";import{a as ge,b as he}from"./chunk-EPWQGGST.js";import{a as pe,c as me,d as ue,e as fe}from"./chunk-KX6WABM7.js";import{a as se,b as le,c as de,d as ce}from"./chunk-CDBM4L77.js";import{a as ie}from"./chunk-FEPN34VA.js";import{a as re,c as E}from"./chunk-KB7U2Z4W.js";import{g as te}from"./chunk-QA4PX2VU.js";import{L as ne,Q as oe,ta as ae}from"./chunk-666DXB2I.js";import{i as ee}from"./chunk-WQZ5FTDX.js";import{Ac as b,F as z,Hb as g,Ib as L,Jb as m,Lb as O,Mb as P,Nb as A,Ob as C,Oc as Y,Pb as a,Qb as r,Rb as S,Vb as B,Xb as y,Yb as f,_ as N,ac as $,bc as R,c as F,cc as j,d as V,fb as s,h as U,hc as W,kc as l,l as k,la as u,lc as T,mc as q,nc as J,p as G,pc as Z,qa as _,qb as x,qc as K,ra as v,rc as X,t as H,z as Q,zc as w}from"./chunk-GHECAUUU.js";function Te(n,t){if(n&1&&(a(0,"mat-chip",2),l(1),r()),n&2){let e=t.$implicit;s(),q(" ",e," ")}}function Ee(n,t){if(n&1&&(a(0,"p"),l(1),r(),a(2,"mat-chip-set"),P(3,Te,2,1,"mat-chip",2,O),r()),n&2){let e=f();s(),J("Found ",e.tags.length," tag",e.tags.length===1?"":"s","."),s(2),A(e.tags)}}function Me(n,t){n&1&&(a(0,"p"),l(1,"Found no tags."),r())}function De(n,t){if(n&1&&(a(0,"ul")(1,"li",4),l(2),r()()),n&2){let e=t.$implicit;s(2),T(e)}}function Ie(n,t){if(n&1&&(a(0,"div",1)(1,"mat-icon",3),l(2,"error_outline"),r(),a(3,"p"),l(4," There is something wrong with the tags in your document. Please review and fix the following issues: "),r(),P(5,De,3,1,"ul",null,O),r()),n&2){let e=f();s(5),A(e.tagErrors)}}var M=class n{tags=[];tagErrors=[];static \u0275fac=function(e){return new(e||n)};static \u0275cmp=x({type:n,selectors:[["app-tags"]],inputs:{tags:"tags",tagErrors:"tagErrors"},decls:4,vars:2,consts:[[1,"tags-container"],[1,"error","mat-elevation-z2"],["color","primary"],["color","warn","inline",""],[1,"error-message"]],template:function(e,i){e&1&&(a(0,"div",0),g(1,Ee,5,2)(2,Me,2,0,"p"),g(3,Ie,7,0,"div",1),r()),e&2&&(s(),m(i.tags.length?1:2),s(2),m(i.tagErrors&&i.tagErrors.length>0?3:-1))},dependencies:[we,_e,ve,E],styles:["[_nghost-%COMP%]   .tags-container[_ngcontent-%COMP%]{overflow-y:auto;padding-left:8px}[_nghost-%COMP%]   .tags-container[_ngcontent-%COMP%]   mat-chip[_ngcontent-%COMP%]{margin:0 4px 4px 0;font-size:14px}"]})};var Ve=["hightlightTagsDrawer"],ke=["pdfViewer"];function Le(n,t){n&1&&(a(0,"h2"),l(1),r()),n&2&&(s(),T(t.content.title))}function Oe(n,t){n&1&&S(0,"h2")}function Pe(n,t){n&1&&(a(0,"h2"),l(1,"Oh oh!"),r())}function Ae(n,t){n&1&&(a(0,"div",12),S(1,"mat-spinner"),r())}function Be(n,t){if(n&1){let e=B();a(0,"app-pdf-viewer",15,1),y("pdfLoaded",function(o){_(e);let d=f(2);return v(d.pdfLoaded(o))}),r()}if(n&2){let e=f(2);C("base64Src",t.pdf)("height",e.height)("width",e.width)("backgroundColor","var(--mat-sidenav-content-background-color, var(--mat-sys-background))")}}function $e(n,t){if(n&1&&(g(0,Be,2,4,"app-pdf-viewer",14),w(1,"async")),n&2){let e,i=f();m((e=b(1,1,i.doc$))?0:-1,e)}}function Re(n,t){n&1&&(a(0,"div",13),l(1,"Something went wrong loading the document."),r())}var p=class{id="";height="100vh";width="812px";hightlightTagsDrawer;pdfViewer;_route=u(te);_googleAuthService=u(ae);_googleDriveService=u(he);_googleDocsService=u(ge);_lastVisited=u(ie);_cdr=u(Y);_docSubject=new k(null);_docLoadStateSubject=new k("loading");isLoggedIn$;doc$=this._docSubject.asObservable();docLoadState$=this._docLoadStateSubject.asObservable();isPanelOpen=!1;tags=[];tagErrors=[];constructor(){this.isLoggedIn$=this._googleAuthService.getIsLoggedIn()}ngOnInit(){let t=this._route.snapshot.paramMap.get("id");t&&this._lastVisited.setLastEditorId(t)}ngAfterViewInit(){this.isLoggedIn$.pipe(fe(this)).subscribe(t=>{t&&this.id?.length&&this.loadResource(this.id)})}loadResource(t){t?.length&&(this._docLoadStateSubject.next("loading"),Q([this._googleDriveService.exportFileAsPdf(t).pipe(N(e=>Se(e))),this._googleDriveService.exportFileAsText(t),this._googleDocsService.getDocument(t)]).pipe(H(([e,i,o])=>({pdf:e,text:i,content:o})),z(e=>(console.error("Failed to get document",e),this.tagErrors=[],this.tags=[],this._docLoadStateSubject.next("error"),G(null)))).subscribe(e=>{e&&(this.tagErrors=this.validateDoubleAngleTokens(e.text),this.tags=this.tagErrors.length===0?this.extractDoubleAngleTags(e.text):[],this._docSubject.next(e),this._docLoadStateSubject.next("loaded"),this._cdr.markForCheck())}))}downloadPDF(t){let e=window.URL.createObjectURL(t),i=document.createElement("a");i.href=e,i.download="exported-doc.pdf",i.click()}toUint8Array(t){return new U(e=>{let i=new FileReader;return i.onload=()=>{i.result instanceof ArrayBuffer?(e.next(new Uint8Array(i.result)),e.complete()):e.error(new Error("FileReader did not return an ArrayBuffer."))},i.onerror=o=>{e.error(o)},i.readAsArrayBuffer(t),()=>{i.abort()}})}extractDoubleAngleTags(t){let e=/<<([\s\S]*?)>>/g,i=new Set,o;for(;(o=e.exec(t))!==null;)i.add(o[1]);return Array.from(i)}sanitizeTag(t){let e=t.trim().replace(/\s+/g," ");return e=e.replace(/\b\w+/g,i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()),e}validateDoubleAngleTokens(t){let e=[],i=/<<([\s\S]*?)>>/g,o,d=[],h=0,D=(t.match(/<</g)||[]).length,I=(t.match(/>>/g)||[]).length;for(;(o=i.exec(t))!==null;){d.push(o.index),h++,D--,I--;let c=o[1];if(c.trim().length===0){e.push('Tag cannot be empty: "<<>>" found.');continue}/^[a-zA-Z0-9\s]+$/.test(c)||e.push(`Invalid characters in tag: "${c}". Only alphanumeric characters and whitespace allowed.`),/^\s|\s$/.test(c)&&e.push(`Extra whitespace before or after angle brackets: "<<${c}>>". Tags cannot start or end with whitespace.`),/\t|\n|\r/.test(c)&&e.push(`Invalid whitespace in tag: "<<${c}>>". Only single spaces allowed between words.`),/ {2,}/.test(c)&&e.push(`Multiple consecutive spaces in token: "<<${c}>>". Only single spaces allowed between words.`)}return(D!==0||I!==0)&&e.push(`Mismatched brackets: found ${D+h} opening << and ${I+h} closing >>.`),e}pdfLoaded(t){this.hightlightTagsDrawer.opened&&this.highlightTags()}toggleHighlightTags(){this.hightlightTagsDrawer.toggle().then(t=>{this.hightlightTagsDrawer.opened?this.highlightTags():this.clearHighlights()})}clearHighlights(){this.pdfViewer&&this.pdfViewer.setSearchText("")}highlightTags(){this.tags&&this.pdfViewer&&this.pdfViewer.setSearchText(this.tags.map(t=>`<<${t}>>`))}refresh(){this.loadResource(this.id)}};V(p,"\u0275fac",function(e){return new(e||p)}),V(p,"\u0275cmp",x({type:p,selectors:[["app-documents"]],viewQuery:function(e,i){if(e&1&&($(Ve,5),$(ke,5)),e&2){let o;R(o=j())&&(i.hightlightTagsDrawer=o.first),R(o=j())&&(i.pdfViewer=o.first)}},inputs:{id:"id",height:"height",width:"width"},decls:29,vars:20,consts:[["hightlightTagsDrawer",""],["pdfViewer",""],[1,"spacer"],["type","button","aria-label","Refresh","matIconButton","","matTooltip","Refresh",3,"click","disabled"],["aria-label","Refresh"],["mat-raised-button","",3,"click"],[1,"sidenav-container"],["mode","side","position","end",3,"openedChange","opened","fixedInViewport","fixedTopGap","fixedBottomGap"],[1,"sidenav-header"],["type","button","aria-label","Close","matIconButton","",3,"click"],["aria-label","Close"],[3,"tags","tagErrors"],[1,"spinner-container"],[1,"error"],[3,"base64Src","height","width","backgroundColor"],[3,"pdfLoaded","base64Src","height","width","backgroundColor"]],template:function(e,i){if(e&1){let o=B();a(0,"div")(1,"mat-toolbar"),g(2,Le,2,1,"h2"),w(3,"async"),L(4,Oe,1,0,"h2"),g(5,Pe,2,0,"h2"),w(6,"async"),S(7,"span",2),a(8,"button",3),w(9,"async"),y("click",function(){return _(o),v(i.refresh())}),a(10,"mat-icon",4),l(11,"refresh"),r()(),a(12,"button",5),y("click",function(){return _(o),v(i.toggleHighlightTags())}),l(13," Highlight Tags "),r()(),a(14,"mat-sidenav-container",6)(15,"mat-sidenav",7,0),X("openedChange",function(h){return _(o),K(i.isPanelOpen,h)||(i.isPanelOpen=h),v(h)}),a(17,"div",8)(18,"h2"),l(19,"Tags"),r(),a(20,"button",9),y("click",function(){return _(o),v(i.toggleHighlightTags())}),a(21,"mat-icon",10),l(22,"close"),r()()(),S(23,"app-tags",11),r(),a(24,"mat-sidenav-content"),g(25,Ae,2,0,"div",12),w(26,"async"),L(27,$e,2,3)(28,Re,2,0,"div",13),r()()()}if(e&2){let o,d;s(2),m((o=b(3,12,i.doc$))?2:4,o),s(3),m(b(6,14,i.docLoadState$)=="error"?5:-1),s(3),C("disabled",!b(9,16,i.isLoggedIn$)),s(6),W("height",i.height),s(),Z("opened",i.isPanelOpen),C("fixedInViewport",!1)("fixedTopGap",0)("fixedBottomGap",0),s(8),C("tags",i.tags)("tagErrors",i.tagErrors),s(2),m((d=b(26,18,i.docLoadState$))==="loading"?25:d==="loaded"?27:d==="error"?28:-1)}},dependencies:[ee,ce,le,de,se,E,ne,oe,me,M,re,be,pe,Ce],styles:["[_nghost-%COMP%]   .sidenav-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between}[_nghost-%COMP%]   mat-sidenav[_ngcontent-%COMP%]{width:300px}"]})),p=F([ue()],p);export{p as a};
